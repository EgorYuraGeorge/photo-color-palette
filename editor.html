<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Редактор изображения</title>
  <link rel="stylesheet" href="style/style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
  <style>
    body {
      background-color: #333;
      color: #fff;
      text-align: center;
    }
    #main-image {
      max-width: 90vw;
      max-height: 70vh;
      border-radius: 20px;
      margin-top: 20px;
    }
    #palette {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.8s ease;
    }
    .color-box {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      margin: 10px;
      position: relative;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      cursor: pointer;
    }
    .color-box span {
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8em;
      color: #ddd;
    }
    .nav-buttons {
      margin-top: 20px;
    }
    .nav-buttons button {
      background-color: #555;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Редактор изображения</h1>
  <img id="main-image" crossorigin="anonymous" />
  <div id="palette"></div>
  <div class="nav-buttons">
    <button id="prev">← Назад</button>
    <button id="save">+ В подборку</button>
    <button id="next">Вперёд →</button>
  </div>

  <script>
    const imgElement = document.getElementById('main-image');
    const paletteContainer = document.getElementById('palette');
    let imageList = JSON.parse(localStorage.getItem('photoList') || '[]');
    let currentIndex = parseInt(localStorage.getItem('photoIndex') || '0');

    function loadImage(index) {
      if (imageList.length === 0) return;
      imgElement.src = imageList[index];
      imgElement.onload = () => extractPalette();
    }

    function extractPalette() {
      const colorThief = new ColorThief();
      if (imgElement.complete) {
        try {
          const colors = colorThief.getPalette(imgElement, 6);
          paletteContainer.innerHTML = '';
          colors.forEach(color => {
            const hex = rgbToHex(color[0], color[1], color[2]);
            fetch(`https://www.thecolorapi.com/id?hex=${hex.replace('#','')}`)
              .then(res => res.json())
              .then(data => {
                const div = document.createElement('div');
                div.className = 'color-box';
                div.style.backgroundColor = hex;
                div.innerHTML = `<span>${data.name.value}</span>`;
                div.title = hex;
                paletteContainer.appendChild(div);
              });
          });
          paletteContainer.style.opacity = '1';
          paletteContainer.style.transform = 'translateY(0)';
        } catch (err) {
          console.error('Ошибка получения палитры:', err);
        }
      }
    }

    function rgbToHex(r, g, b) {
      return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
    }

    document.getElementById('prev').addEventListener('click', () => {
      currentIndex = (currentIndex - 1 + imageList.length) % imageList.length;
      localStorage.setItem('photoIndex', currentIndex);
      loadImage(currentIndex);
    });

    document.getElementById('next').addEventListener('click', () => {
      currentIndex = (currentIndex + 1) % imageList.length;
      localStorage.setItem('photoIndex', currentIndex);
      loadImage(currentIndex);
    });

    document.getElementById('save').addEventListener('click', () => {
      const saved = JSON.parse(localStorage.getItem('savedProjects') || '[]');
      if (!saved.includes(imageList[currentIndex])) {
        saved.push(imageList[currentIndex]);
        localStorage.setItem('savedProjects', JSON.stringify(saved));
        alert('Добавлено в подборку!');
      } else {
        alert('Уже в подборке.');
      }
    });

    loadImage(currentIndex);
  </script>
</body>
</html>
